<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPM ‚Ä¢ IA Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #FF2448;
            --accent: #00C1FF; --whatsapp: #25D366;
            --fuego: #ff5e37; --agua: #37b3ff; --tierra: #7ad65d; --aire: #dfe6e9;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; line-height: 1.6; overflow-x: hidden; }
        .container { width: 95%; max-width: 550px; margin: auto; padding: 20px; }
        .card { background: var(--card); border-radius: 24px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        h1 { font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 10px; text-align: center; }
        .btn { width: 100%; padding: 18px; border-radius: 14px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.3s; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; color: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-outline { background: rgba(255,255,255,0.05); color: #94a3b8; }
        .hidden { display: none; }
        .menu-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .slider-container { margin: 40px 0; text-align: center; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 10px; background: #334155; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { height: 28px; width: 28px; border-radius: 50%; background: var(--accent); cursor: pointer; -webkit-appearance: none; margin-top: -9px; box-shadow: 0 0 15px rgba(0,193,255,0.4); }
        .val-display { font-size: 4rem; font-weight: 900; color: var(--accent); margin: 10px 0; }
        .tag { padding: 4px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .fuego { background: var(--fuego); } .agua { background: var(--agua); } .tierra { background: var(--tierra); } .aire { background: var(--aire); color: #000; }
        #ai-loading { text-align: center; padding: 20px; font-weight: bold; color: var(--accent); }
        .logo-img { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: block; border: 2px solid var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-home" class="card">
        <img src="logo.png" alt="MPM" class="logo-img" onerror="this.style.display='none'">
        <h1>Preemptive Movement</h1>
        <p style="text-align:center">Decodificaci√≥n de estados mediante IA Gemini Pro.</p>
        <button class="btn btn-primary" onclick="showScreen('screen-menu')">INICIAR DIAGN√ìSTICO</button>
    </div>

    <div id="screen-menu" class="hidden">
        <div class="card">
            <h2>M√≥dulos</h2>
            <div id="menu-list" class="menu-grid"></div>
            <button class="btn btn-outline" onclick="showScreen('screen-home')">Volver</button>
        </div>
    </div>

    <div id="screen-test" class="hidden">
        <div class="card">
            <div id="test-progress" style="color:var(--accent); font-size: 0.8rem;"></div>
            <h3 id="question-text">-</h3>
            <div class="slider-container">
                <input type="range" id="main-slider" min="1" max="10" step="1" oninput="updateUIValue()">
                <div class="val-display" id="display-value">5</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1" onclick="prevQ()">Atr√°s</button>
                <button class="btn btn-primary" style="flex:2" onclick="nextQ()">Siguiente</button>
            </div>
        </div>
    </div>

    <div id="screen-results" class="hidden">
        <div class="card">
            <h1>Informe IA</h1>
            <canvas id="mpmChart"></canvas>
            <div id="ai-loading" class="hidden">Analizando con IA...</div>
            <div id="text-results"></div>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px;">
                <input type="text" id="userName" placeholder="Tu nombre" style="width:100%; padding:12px; border-radius:8px; border:none; margin-bottom:10px; background:#0f172a; color:white;">
                <button class="btn btn-whatsapp" onclick="sendWhatsApp()">ENVIAR A CONSULTOR</button>
            </div>
            <button class="btn btn-outline" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>
</div>

<script>
const testsData = {
    colores: { n:"üé® Colores", q:["Rojo","Azul","Verde","Amarillo","Negro","Blanco","Morado","Naranja","Rosa","Gris","Turquesa","Marr√≥n","Dorado","Plateado","Beige","Fucsia"]},
    ciudades: { n:"üåÜ Ciudades", q:["Tokio","Par√≠s","Nueva York","Roma","Londres","S√≠dney","√Åmsterdam","Se√∫l","Barcelona","Los √Ångeles","Dub√°i","Berl√≠n","Buenos Aires","Toronto","El Cairo","Madrid"]},
    autos: { n:"üöó Autom√≥viles", q:["Ferrari","Toyota","Mercedes","Audi","Tesla","Ford","BMW","Chevrolet","Lamborghini","Honda","Porsche","Hyundai","Range Rover","Volkswagen","Peugeot","Citro√´n"]},
    alimentos: { n:"üçΩ Alimentos", q:["Chocolate","Manzana","Caf√©","Pan","Carne","Pasta","Arroz","Queso","Pollo","Miel","Nueces","Salm√≥n","Fresas","Aguacate","Huevos","Yogur"]},
    profesiones: { n:"üíº Profesiones", q:["M√©dico","Artista","Ingeniero","Abogado","Maestro","Programador","Empresario","Psic√≥logo","Chef","Polic√≠a","Arquitecto","Deportista","Cient√≠fico","Actor","Piloto","Escritor"]},
    animales: { n:"ü¶Å Animales", q:["Le√≥n","Lobo","√Åguila","Delf√≠n","Tigre","Serpiente","Perro","Gato","Caballo","B√∫ho","Tibur√≥n","Oso","Cuervo","Conejo","Toro","Halc√≥n"]},
    estaciones: { n:"üçÅ Estaciones", q:["Primavera","Verano","Oto√±o","Invierno","Amanecer","Atardecer","Mediod√≠a","Medianoche","Clima tropical","Clima √°rtico","Clima templado","Clima des√©rtico","Ambiente h√∫medo","Ambiente seco","Zona monta√±osa","Zona costera"]},
    instrumentos: { n:"üéµ Instrumentos", q:["Piano","Guitarra","Viol√≠n","Flauta","Bater√≠a","Saxof√≥n","Arpa","Trompeta","Bajo","Acorde√≥n","Ukelele","Timbal","DJ Mixer","Voz humana","√ìrgano","Cello"]},
    paises: { n:"üåç Pa√≠ses", q:["Jap√≥n","Estados Unidos","Francia","Espa√±a","Alemania","Italia","M√©xico","Brasil","Argentina","Canad√°","Australia","Egipto","India","China","Rusia","Grecia"]},
    metales: { n:"üî© Metales", q:["Oro","Plata","Bronce","Cobre","Hierro","Plomo","Titanio","Mercurio","Acero","Lat√≥n","Platino","Wolframio","N√≠quel","Aluminio","Cobalto","Iridio"]},
    paisajes: { n:"üèû Paisajes", q:["Mar","Bosque","Monta√±a","Desierto","Cascada","Pradera","Jungla","Cueva","Glaciar","Ca√±√≥n","Volc√°n","Llanura","Isla","Tundra","Sabana","Arrecife"]},
    arquitectura: { n:"üèõ Arquitectura", q:["Minimalista","Barroco","G√≥tico","Rom√°nico","Brutalista","Art Deco","Cl√°sico","Futurista","Industrial","Neocl√°sico","Org√°nico","Colonial","High-Tech","Renacentista","Moderno","Posmoderno"]},
    sabores: { n:"üçØ Sabores", q:["Dulce","√Åcido","Amargo","Salado","Umami","Picante","Agridulce","Herbal","Tostado","Fresco","Cremoso","Fermentado","Marino","Ahumado","Frutal","Especiado"]},
    tecnologias: { n:"üì≤ Tecnolog√≠as", q:["IA","Rob√≥tica","Web3","Cripto","Medicina","Bioingenier√≠a","Big Data","Nano","VR","Sat√©lites","EVs","IoT","Cloud","Fusi√≥n","Drones","Quantum"]},
    epocas: { n:"‚åõ √âpocas", q:["Grecia","Roma","Edad Media","Renacimiento","Ilustraci√≥n","Rev Industrial","A√±os 20","A√±os 50","A√±os 80","Actualidad","Futuro Cercano","Futuro Lejano","Barroco","Romanticismo","Modernismo","Transhumanismo"]},
    arquetipos: { n:"üî± Arquetipos", q:["Drag√≥n","F√©nix","Unicornio","Kraken","Pegaso","Minotauro","Sirena","Grifo","Quimera","Anubis","Thor","Medusa","Zeus","Hades","Ra","Od√≠n"]}
};

const tablaMPM = {
    "1111":[1,"fuego", 4,"Alta energ√≠a."], "0000":[2,"fuego",-3,"Energ√≠a contenida."],
    "0110":[3,"agua", 4,"Emoci√≥n en expansi√≥n."], "1001":[4,"agua",-3,"Acumulaci√≥n emocional."],
    "1000":[5,"aire", 4,"Mente clara."], "0001":[6,"tierra",-3,"Falta estructura."],
    "1110":[7,"tierra", 4,"Ra√≠z s√≥lida."], "0111":[8,"aire",-3,"Mucha mente activa."]
};

let currentModule = ''; let currentIdx = 0; let scores = []; let lastResult = {};

function showScreen(id) {
    document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

function init() {
    const list = document.getElementById('menu-list');
    Object.keys(testsData).forEach(key => {
        const b = document.createElement('button');
        b.className = 'btn btn-outline';
        b.innerText = testsData[key].n;
        b.onclick = () => { currentModule = key; currentIdx = 0; scores = Array(16).fill(5); loadQuestion(); showScreen('screen-test'); };
        list.appendChild(b);
    });
}

function loadQuestion() {
    document.getElementById('test-progress').innerText = `${testsData[currentModule].n} - ${currentIdx+1}/16`;
    document.getElementById('question-text').innerText = testsData[currentModule].q[currentIdx];
    document.getElementById('display-value').innerText = scores[currentIdx];
    document.getElementById('main-slider').value = scores[currentIdx];
}

function updateUIValue() {
    scores[currentIdx] = parseInt(document.getElementById('main-slider').value);
    document.getElementById('display-value').innerText = scores[currentIdx];
}

function nextQ() {
    if(currentIdx < 15) { currentIdx++; loadQuestion(); }
    else { processAIResults(); }
}

function prevQ() { if(currentIdx > 0) { currentIdx--; loadQuestion(); } }

async function processAIResults() {
    showScreen('screen-results');
    document.getElementById('ai-loading').classList.remove('hidden');
    
    const getB = (s) => {
        const bits = scores.slice(s, s+4).map(v => v >= 5 ? "1" : "0").join("");
        const d = tablaMPM[bits] || [9, "aire", 0, "Estado Neutro"];
        return { id:d[0], elem:d[1], val:d[2], msg:d[3] };
    };

    lastResult = { b1:getB(0), b2:getB(4), b3:getB(8), b4:getB(12), total:getB(0).val+getB(4).val+getB(8).val+getB(12).val };
    renderChart(scores);

    try {
        const response = await fetch('/.netlify/functions/analisis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ resultados: lastResult, modulo: testsData[currentModule].n })
        });
        const data = await response.json();
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('text-results').innerHTML = `
            <div style="border-left: 4px solid var(--accent); padding-left: 15px; margin-top:20px;">
                <p><strong>SITUACI√ìN:</strong> <span class="tag ${lastResult.b1.elem}">${lastResult.b1.elem}</span></p>
                <p style="font-size: 1.1rem; color: #fff;">${data.interpretacion}</p>
            </div>
        `;
    } catch (e) {
        document.getElementById('ai-loading').innerText = "Error de conexi√≥n. Revisa netlify.toml y la API Key.";
    }
}

function renderChart(sc) {
    const ctx = document.getElementById('mpmChart').getContext('2d');
    const data = [sc.slice(0,4).reduce((a,b)=>a+b)/4, sc.slice(4,8).reduce((a,b)=>a+b)/4, sc.slice(8,12).reduce((a,b)=>a+b)/4, sc.slice(12,16).reduce((a,b)=>a+b)/4];
    new Chart(ctx, { type: 'radar', data: { labels: ['S', 'M', 'T', 'R'], datasets: [{ data, backgroundColor: 'rgba(0,193,255,0.2)', borderColor: '#00C1FF' }] }, options: { scales: { r: { min:0, max:10, ticks: { display:false } } }, plugins: { legend: { display:false } } } });
}

function sendWhatsApp() {
    const name = document.getElementById('userName').value || "Cliente";
    const text = `Hola, soy ${name}. Diagn√≥stico MPM finalizado. Resultados: S:${lastResult.b1.id}, M:${lastResult.b2.id}, T:${lastResult.b3.id}, R:${lastResult.b4.id}.`;
    window.open(`https://wa.me/34672680535?text=${encodeURIComponent(text)}`);
}

init();
</script>
</body>
</html>
